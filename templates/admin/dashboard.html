{% extends "admin/base.html" %}

{% block title %}Admin Dashboard - ACIS Trading Platform{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<!-- Overview Stats -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body position-relative">
                <div class="stat-value text-primary">
                    {{ "${:,.0f}".format(data.portfolio.total_value or 0) }}
                </div>
                <div class="stat-label">Total Portfolio Value</div>
                <div class="stat-icon text-primary">
                    <i class="fas fa-dollar-sign"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body position-relative">
                <div class="stat-value text-info">
                    {{ data.portfolio.total_positions or 0 }}
                </div>
                <div class="stat-label">Active Positions</div>
                <div class="stat-icon text-info">
                    <i class="fas fa-chart-pie"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body position-relative">
                <div class="stat-value text-success">
                    {{ data.trades.count or 0 }}
                </div>
                <div class="stat-label">Trades (30 days)</div>
                <div class="stat-icon text-success">
                    <i class="fas fa-exchange-alt"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card stat-card">
            <div class="card-body position-relative">
                <div class="stat-value text-warning">
                    {{ data.alerts.count or 0 }}
                </div>
                <div class="stat-label">Active Alerts</div>
                <div class="stat-icon text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Portfolio Performance Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Portfolio Performance (Last 30 Days)
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" data-period="30d">30D</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-period="90d">90D</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-period="1y">1Y</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Portfolio Allocation -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Strategy Allocation
                </h5>
            </div>
            <div class="card-body">
                <canvas id="allocationChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Activity and Alerts Row -->
<div class="row mb-4">
    <!-- Recent Trading Activity -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Trading Activity
                </h5>
                <a href="/admin/trades" class="btn btn-sm btn-outline-primary">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Action</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Strategy</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-trades">
                            <!-- Will be populated by JavaScript -->
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Loading recent trades...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Alerts -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>
                    System Alerts
                </h5>
                <a href="/admin/alerts" class="btn btn-sm btn-outline-warning">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="system-alerts">
                    <!-- Will be populated by JavaScript -->
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        Loading alerts...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <a href="/admin/strategies/run" class="btn btn-admin-primary w-100">
                            <i class="fas fa-play me-2"></i>
                            Run Strategy
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/portfolios/rebalance" class="btn btn-admin-success w-100">
                            <i class="fas fa-balance-scale me-2"></i>
                            Rebalance
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/reports/generate" class="btn btn-info w-100">
                            <i class="fas fa-file-alt me-2"></i>
                            Generate Report
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="/admin/risk/check" class="btn btn-warning w-100">
                            <i class="fas fa-shield-alt me-2"></i>
                            Risk Check
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-3">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <div class="fw-bold">Database</div>
                                <small class="text-muted">Connected</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <div class="fw-bold">Market Data</div>
                                <small class="text-muted">Real-time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center mb-3">
                            <div class="status-indicator bg-warning me-3"></div>
                            <div>
                                <div class="fw-bold">Trading</div>
                                <small class="text-muted">Paper Mode</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="status-indicator bg-success me-3"></div>
                            <div>
                                <div class="fw-bold">Scheduler</div>
                                <small class="text-muted">Running</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Performance Summary
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h4 text-success mb-1">
                                {{ "+{:.1f}%".format(data.portfolio.avg_return or 0) if (data.portfolio.avg_return or 0) > 0 else "{:.1f}%".format(data.portfolio.avg_return or 0) }}
                            </div>
                            <small class="text-muted">30-Day Return</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-info mb-1">1.24</div>
                        <small class="text-muted">Sharpe Ratio</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="h4 text-primary mb-1">-5.2%</div>
                            <small class="text-muted">Max Drawdown</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-secondary mb-1">18.5%</div>
                        <small class="text-muted">Volatility</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .alert-item {
        padding: 0.75rem;
        border-left: 3px solid;
        margin-bottom: 0.5rem;
        border-radius: 0 0.25rem 0.25rem 0;
        background: #f8f9fa;
    }
    
    .alert-item.alert-critical {
        border-left-color: #dc3545;
    }
    
    .alert-item.alert-warning {
        border-left-color: #fd7e14;
    }
    
    .alert-item.alert-info {
        border-left-color: #0dcaf0;
    }
    
    .trade-status-filled {
        background: #d4edda;
        color: #155724;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .trade-status-pending {
        background: #fff3cd;
        color: #856404;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts
    initPerformanceChart();
    initAllocationChart();
    
    // Load real-time data
    loadRecentTrades();
    loadSystemAlerts();
    
    // Auto-refresh every 30 seconds
    setInterval(function() {
        loadRecentTrades();
        loadSystemAlerts();
    }, 30000);
});

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    // Sample data - in production this would come from API
    const dates = [];
    const portfolioValues = [];
    const benchmarkValues = [];
    
    // Generate sample data for last 30 days
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString());
        
        // Simulate portfolio performance
        const baseValue = 1000000;
        const trend = (30 - i) * 500;
        const volatility = Math.random() * 10000 - 5000;
        portfolioValues.push(baseValue + trend + volatility);
        
        // Simulate benchmark (slightly lower performance)
        const benchmarkTrend = (30 - i) * 300;
        const benchmarkVolatility = Math.random() * 8000 - 4000;
        benchmarkValues.push(baseValue + benchmarkTrend + benchmarkVolatility);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Portfolio',
                data: portfolioValues,
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(44, 62, 80, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.1
            }, {
                label: 'S&P 500',
                data: benchmarkValues,
                borderColor: '#95a5a6',
                backgroundColor: 'rgba(149, 165, 166, 0.1)',
                borderWidth: 2,
                fill: false,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + (value / 1000000).toFixed(2) + 'M';
                        }
                    }
                }
            }
        }
    });
}

function initAllocationChart() {
    const ctx = document.getElementById('allocationChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Small Cap Value', 'Mid Cap Growth', 'Large Cap Momentum', 'Dividend Focus', 'Other'],
            datasets: [{
                data: [25, 20, 18, 15, 22],
                backgroundColor: [
                    '#2c3e50',
                    '#3498db', 
                    '#e74c3c',
                    '#f39c12',
                    '#95a5a6'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function loadRecentTrades() {
    // Simulate loading recent trades
    const trades = [
        {
            time: '09:45',
            symbol: 'AAPL',
            action: 'BUY',
            quantity: 100,
            price: 150.25,
            strategy: 'Large Cap Growth',
            status: 'Filled'
        },
        {
            time: '10:15',
            symbol: 'GOOGL',
            action: 'SELL',
            quantity: 50,
            price: 2800.50,
            strategy: 'Large Cap Momentum',
            status: 'Filled'
        },
        {
            time: '11:30',
            symbol: 'MSFT',
            action: 'BUY',
            quantity: 75,
            price: 340.75,
            strategy: 'Large Cap Value',
            status: 'Pending'
        }
    ];
    
    const tbody = document.getElementById('recent-trades');
    tbody.innerHTML = trades.map(trade => `
        <tr>
            <td>${trade.time}</td>
            <td><strong>${trade.symbol}</strong></td>
            <td>
                <span class="badge ${trade.action === 'BUY' ? 'bg-success' : 'bg-danger'}">
                    ${trade.action}
                </span>
            </td>
            <td>${trade.quantity.toLocaleString()}</td>
            <td>$${trade.price.toFixed(2)}</td>
            <td><small class="text-muted">${trade.strategy}</small></td>
            <td>
                <span class="trade-status-${trade.status.toLowerCase()}">
                    ${trade.status}
                </span>
            </td>
        </tr>
    `).join('');
}

function loadSystemAlerts() {
    // Simulate loading system alerts
    const alerts = [
        {
            type: 'warning',
            time: '2 min ago',
            title: 'Portfolio Concentration Alert',
            message: 'AAPL position exceeds 5% of portfolio'
        },
        {
            type: 'info',
            time: '15 min ago',
            title: 'Strategy Execution Complete',
            message: 'Small Cap Value rebalancing finished successfully'
        },
        {
            type: 'critical',
            time: '1 hour ago',
            title: 'Risk Limit Breach',
            message: 'Daily loss limit approached for Mid Cap Growth'
        }
    ];
    
    const alertsContainer = document.getElementById('system-alerts');
    alertsContainer.innerHTML = alerts.map(alert => `
        <div class="alert-item alert-${alert.type}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="fw-bold">${alert.title}</div>
                    <small class="text-muted">${alert.message}</small>
                </div>
                <small class="text-muted">${alert.time}</small>
            </div>
        </div>
    `).join('');
}

// Period selector for performance chart
document.querySelectorAll('[data-period]').forEach(btn => {
    btn.addEventListener('click', function() {
        // Update active state
        document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // In production, this would reload chart with new data
        console.log('Loading data for period:', this.dataset.period);
    });
});
</script>
{% endblock %}